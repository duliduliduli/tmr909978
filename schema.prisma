generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String           @id @default(cuid())
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  email              String           @unique
  passwordHash       String?
  emailVerified      Boolean          @default(false)
  firstName          String
  lastName           String
  phone              String?
  avatar             String?
  isActive           Boolean          @default(true)
  lastLoginAt        DateTime?
  stripeCustomerId   String?          @unique
  bookingsAsCustomer Booking[]        @relation("CustomerBookings")
  customerProfile    CustomerProfile?
  providerProfile    ProviderProfile?
  reviewsReceived    Review[]         @relation("ReviewsReceived")
  reviewsGiven       Review[]         @relation("ReviewsGiven")

  @@map("users")
}

model CustomerProfile {
  id                String                @id @default(cuid())
  userId            String                @unique
  defaultAddress    String?
  defaultLatitude   Float?
  defaultLongitude  Float?
  defaultCity       String?
  defaultState      String?
  defaultPostalCode String?
  preferredServices String[]
  notes             String?
  totalBookings     Int                   @default(0)
  cancelledBookings Int                   @default(0)
  avgRating         Float?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  coinTransactions  CoinTransaction[]
  coinBalances      CustomerCoinBalance[]
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  savedAddresses    SavedAddress[]

  @@map("customer_profiles")
}

model ProviderProfile {
  id                  String             @id @default(cuid())
  userId              String             @unique
  businessName        String
  businessDescription String?
  businessPhone       String?
  businessEmail       String?
  businessAddress     String?
  serviceRadius       Float              @default(25.0)
  baseLatitude        Float?
  baseLongitude       Float?
  serviceCities       String[]
  stripeAccountId     String?            @unique
  stripeOnboarded     Boolean            @default(false)
  isVerified          Boolean            @default(false)
  verifiedAt          DateTime?
  businessLicense     String?
  insurance           String?
  totalBookings       Int                @default(0)
  completedBookings   Int                @default(0)
  cancelledBookings   Int                @default(0)
  avgRating           Float?
  responseTime        Int?
  isAcceptingBookings Boolean            @default(true)
  autoAcceptBookings  Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  availabilityRules   AvailabilityRule[]
  bookings            Booking[]
  businessCoin        BusinessCoin?
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceAreas        ServiceArea[]
  services            Service[]
  payoutRecords       PayoutRecord[]
  providerStrikes     ProviderStrike[]

  @@map("provider_profiles")
}

model Service {
  id                String          @id @default(cuid())
  providerId        String
  name              String
  description       String?
  category          ServiceCategory
  basePrice         Float
  priceType         PriceType
  estimatedDuration Int
  requiresWater     Boolean         @default(false)
  requiresPower     Boolean         @default(false)
  isActive          Boolean         @default(true)
  addOns            Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  bookings          Booking[]
  provider          ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@map("services")
}

model AvailabilityRule {
  id            String           @id @default(cuid())
  providerId    String
  ruleType      AvailabilityType
  dayOfWeek     Int?
  startTime     String
  endTime       String
  startDate     DateTime?
  endDate       DateTime?
  bufferMinutes Int              @default(0)
  isBreakTime   Boolean          @default(false)
  maxConcurrent Int              @default(1)
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  provider      ProviderProfile  @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("availability_rules")
}

model Booking {
  id                    String            @id @default(cuid())
  bookingNumber         String            @unique
  customerId            String
  providerId            String
  serviceId             String
  status                BookingStatus     @default(DRAFT)
  currentState          String
  scheduledStartTime    DateTime
  scheduledEndTime      DateTime
  actualStartTime       DateTime?
  actualEndTime         DateTime?
  serviceAddress        String
  serviceLatitude       Float
  serviceLongitude      Float
  serviceCity           String?
  serviceState          String?
  servicePostalCode     String?
  baseAmount            Float
  addOnsAmount          Float?
  taxAmount             Float?
  tipAmount             Float?
  totalAmount           Float
  platformFee           Float?
  stripePaymentIntentId String?           @unique
  stripeTransferId      String?
  paymentMethod         String?
  coinsRedeemed         Int?
  coinDiscount          Float?
  coinId                String?
  vehicleInfo           Json?
  specialInstructions   String?
  addOnServices         Json?
  customerNotes         String?
  providerNotes         String?
  completionPhotos      String[]
  customerSignature     String?
  cancellationReason    String?
  cancellationFee       Float?
  cancelledAt           DateTime?
  cancelledBy           CancelledBy?
  disputeStatus         DisputeStatus?
  refundAmount          Float?
  refundedAt            DateTime?
  // Lifecycle timestamps for delayed payout
  autoConfirmAt         DateTime?
  providerArrivedAt     DateTime?
  providerCompletedAt   DateTime?
  customerConfirmedAt   DateTime?
  disputeOpenedAt       DateTime?
  // Provider payment breakdown (in cents)
  providerGross         Int?
  providerNet           Int?
  // Stripe charge ID (needed for separate charges + transfers)
  stripeChargeId        String?           @unique
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  events                BookingEvent[]
  customer              User              @relation("CustomerBookings", fields: [customerId], references: [id])
  provider              ProviderProfile   @relation(fields: [providerId], references: [id])
  service               Service           @relation(fields: [serviceId], references: [id])
  coinTransactions      CoinTransaction[]
  review                Review?
  paymentRecords        PaymentRecord[]
  payoutRecords         PayoutRecord[]
  disputeCases          DisputeCase[]
  providerStrikes       ProviderStrike[]

  @@index([customerId])
  @@index([providerId])
  @@index([status])
  @@index([scheduledStartTime])
  @@map("bookings")
}

model BookingEvent {
  id          String   @id @default(cuid())
  bookingId   String
  eventType   String
  fromStatus  String?
  toStatus    String?
  triggeredBy String?
  triggeredAt DateTime @default(now())
  metadata    Json?
  notes       String?
  ipAddress   String?
  userAgent   String?
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, triggeredAt])
  @@map("booking_events")
}

model Review {
  id                    String    @id @default(cuid())
  bookingId             String    @unique
  reviewerId            String
  revieweeId            String
  rating                Int
  title                 String?
  comment               String?
  qualityRating         Int?
  communicationRating   Int?
  timelinessRating      Int?
  professionalismRating Int?
  photos                String[]
  isPublic              Boolean   @default(true)
  isVerified            Boolean   @default(false)
  responseText          String?
  respondedAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  booking               Booking   @relation(fields: [bookingId], references: [id])
  reviewee              User      @relation("ReviewsReceived", fields: [revieweeId], references: [id])
  reviewer              User      @relation("ReviewsGiven", fields: [reviewerId], references: [id])

  @@map("reviews")
}

model ServiceArea {
  id              String          @id @default(cuid())
  providerId      String
  centerLat       Float
  centerLng       Float
  radiusMiles     Float
  boundaryGeoJSON Json?
  cities          String[]
  states          String[]
  postalCodes     String[]
  isActive        Boolean         @default(true)
  provider        ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("service_areas")
}

model PromotionCode {
  id                 String       @id @default(cuid())
  code               String       @unique
  discountType       DiscountType
  discountAmount     Float
  maxUses            Int?
  usedCount          Int          @default(0)
  maxUsesPerUser     Int?
  validFrom          DateTime
  validUntil         DateTime?
  isActive           Boolean      @default(true)
  minOrderAmount     Float?
  applicableServices String[]
  newCustomersOnly   Boolean      @default(false)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@map("promotion_codes")
}

model BusinessCoin {
  id                      String                @id @default(cuid())
  providerId              String                @unique
  name                    String
  displayName             String
  description             String?
  iconUrl                 String?
  primaryColor            String                @default("#3B82F6")
  earnRate                Float                 @default(1.0)
  minimumEarnAmount       Float                 @default(0.0)
  redemptionValue         Float                 @default(0.01)
  minimumRedemption       Int                   @default(100)
  maxRedemptionPerBooking Float?
  isActive                Boolean               @default(true)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  provider                ProviderProfile       @relation(fields: [providerId], references: [id], onDelete: Cascade)
  promotions              CoinPromotion[]
  transactions            CoinTransaction[]
  customerBalances        CustomerCoinBalance[]

  @@map("business_coins")
}

model CustomerCoinBalance {
  id             String          @id @default(cuid())
  customerId     String
  coinId         String
  balance        Int             @default(0)
  totalEarned    Int             @default(0)
  totalRedeemed  Int             @default(0)
  lastEarnedAt   DateTime?
  lastRedeemedAt DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  coin           BusinessCoin    @relation(fields: [coinId], references: [id], onDelete: Cascade)
  customer       CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, coinId])
  @@map("customer_coin_balances")
}

model CoinTransaction {
  id              String              @id @default(cuid())
  coinId          String
  customerId      String
  bookingId       String?
  type            CoinTransactionType
  amount          Int
  description     String?
  dollarAmount    Float?
  previousBalance Int
  newBalance      Int
  createdAt       DateTime            @default(now())
  booking         Booking?            @relation(fields: [bookingId], references: [id])
  coin            BusinessCoin        @relation(fields: [coinId], references: [id], onDelete: Cascade)
  customer        CustomerProfile     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("coin_transactions")
}

model CoinPromotion {
  id                 String       @id @default(cuid())
  coinId             String
  title              String
  description        String?
  requiredCoins      Int
  discountAmount     Float
  maxRedemptions     Int?
  usedCount          Int          @default(0)
  maxPerCustomer     Int?         @default(1)
  validFrom          DateTime
  validUntil         DateTime?
  isActive           Boolean      @default(true)
  minOrderAmount     Float?
  applicableServices String[]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  coin               BusinessCoin @relation(fields: [coinId], references: [id], onDelete: Cascade)

  @@map("coin_promotions")
}

model BookingAnalytics {
  id                 String   @id @default(cuid())
  date               DateTime @unique @db.Date
  totalBookings      Int      @default(0)
  confirmedBookings  Int      @default(0)
  cancelledBookings  Int      @default(0)
  completedBookings  Int      @default(0)
  totalRevenue       Float    @default(0)
  platformRevenue    Float    @default(0)
  avgOrderValue      Float    @default(0)
  avgRating          Float?
  newCustomers       Int      @default(0)
  returningCustomers Int      @default(0)
  cityBreakdown      Json?
  serviceBreakdown   Json?

  @@map("booking_analytics")
}

model SavedAddress {
  id         String          @id @default(cuid())
  customerId String
  label      String
  address    String
  latitude   Float
  longitude  Float
  city       String?
  state      String?
  postalCode String?
  sortOrder  Int             @default(0)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  customer   CustomerProfile @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("saved_addresses")
}

model PaymentRecord {
  id                    String   @id @default(cuid())
  bookingId             String
  stripePaymentIntentId String
  stripeChargeId        String?
  amount                Int      // in cents
  currency              String   @default("usd")
  status                String   // requires_payment_method, succeeded, canceled, etc.
  failureCode           String?
  failureMessage        String?
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  booking               Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([stripePaymentIntentId])
  @@map("payment_records")
}

model PayoutRecord {
  id               String          @id @default(cuid())
  bookingId        String
  providerId       String
  stripeTransferId String?         @unique
  amount           Int             // in cents
  platformFee      Int             // in cents
  currency         String          @default("usd")
  status           PayoutStatus    @default(PENDING_RELEASE)
  scheduledFor     DateTime?
  releasedAt       DateTime?
  failureReason    String?
  metadata         Json?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  booking          Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  provider         ProviderProfile @relation(fields: [providerId], references: [id])

  @@index([bookingId])
  @@index([providerId])
  @@index([status])
  @@map("payout_records")
}

model DisputeCase {
  id              String        @id @default(cuid())
  bookingId       String
  openedBy        String
  openedByRole    CancelledBy
  reasonCode      String
  description     String
  evidenceJson    Json?
  resolution      DisputeStatus @default(UNDER_REVIEW)
  resolutionNotes String?
  refundAmount    Int?
  resolvedAt      DateTime?
  resolvedBy      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("dispute_cases")
}

model ProviderStrike {
  id         String          @id @default(cuid())
  providerId String
  bookingId  String?
  type       String
  points     Int             @default(1)
  reason     String?
  expiresAt  DateTime
  isActive   Boolean         @default(true)
  createdAt  DateTime        @default(now())

  provider   ProviderProfile @relation(fields: [providerId], references: [id])
  booking    Booking?        @relation(fields: [bookingId], references: [id])

  @@index([providerId])
  @@index([expiresAt])
  @@map("provider_strikes")
}

model WebhookEvent {
  id            String   @id @default(cuid())
  stripeEventId String   @unique
  type          String
  processedAt   DateTime @default(now())
  payload       Json?

  @@index([stripeEventId])
  @@map("webhook_events")
}

enum PayoutStatus {
  PENDING_RELEASE
  RELEASED
  BLOCKED_DISPUTE
  FAILED
  REVERSED
}

enum ServiceCategory {
  EXTERIOR_WASH
  INTERIOR_CLEAN
  FULL_DETAIL
  CERAMIC_COATING
  PAINT_CORRECTION
  MAINTENANCE
  SPECIALTY
}

enum PriceType {
  FIXED
  PER_HOUR
  PER_VEHICLE
  CUSTOM
}

enum AvailabilityType {
  WEEKLY_RECURRING
  SPECIFIC_DATE
  BLACKOUT_DATE
  HOLIDAY
}

enum BookingStatus {
  DRAFT
  QUOTE_REQUESTED
  QUOTE_PROVIDED
  PENDING_PAYMENT
  PAYMENT_FAILED
  CONFIRMED
  PROVIDER_ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW_CUSTOMER
  NO_SHOW_PROVIDER
  DISPUTED
  REFUNDED
}

enum CancelledBy {
  CUSTOMER
  PROVIDER
  PLATFORM
}

enum DisputeStatus {
  NONE
  CUSTOMER_DISPUTE
  PROVIDER_DISPUTE
  UNDER_REVIEW
  RESOLVED_CUSTOMER
  RESOLVED_PROVIDER
  RESOLVED_PARTIAL
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SERVICE
}

enum CoinTransactionType {
  EARNED
  REDEEMED
  EXPIRED
  BONUS
  ADJUSTMENT
}
